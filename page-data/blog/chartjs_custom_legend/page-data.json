{"componentChunkName":"component---src-templates-post-template-js","path":"/blog/chartjs_custom_legend","result":{"data":{"markdownRemark":{"frontmatter":{"date":"2021-06-28","title":"Render a custom legend with Chart.js","path":"/blog/chartjs_custom_legend"},"html":"<p>There’s not much information on how to use the Chart.js's <strong>legendCallback</strong> option to generate a custom legend, especially with React functional components/hooks. I had a lot of trouble figuring out how to do this and wanted to share what I learned.</p>\n<p>I needed to create a custom legend to address discrepancies in size between two side-by-side Doughnut charts with different amounts of data. The charts kept rendering with different sizes, and after some Google-ing I decided the best way to solve this would be to generate my own legends.</p>\n<p>To make your own custom legend, you need to make sure that you don’t display the default legend, and then provide your chart with a callback function in its <strong>options</strong> object:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  legend<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    display<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">legendCallback</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// your legend callback function here</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In my case, I wanted to create a simple legend that shows each of my labels next to the color block that represents it in the chart, so this is what the callback looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function-variable function\">legendCallback</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">chartInstance</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> labels <span class=\"token operator\">=</span> chartInstance<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>labels<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> clrs <span class=\"token operator\">=</span> chartInstance<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>backgroundColor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> borderWidth <span class=\"token operator\">=</span> chartInstance<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>borderWidth<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ul className<span class=\"token operator\">=</span><span class=\"token string\">\"chart-legend\"</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>labels <span class=\"token operator\">&amp;&amp;</span>\n        labels<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">label<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token operator\">&lt;</span>li\n            onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handleLegendClick</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">,</span> chartInstance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>div\n              className<span class=\"token operator\">=</span><span class=\"token string\">\"legend-block\"</span>\n              style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n                backgroundColor<span class=\"token operator\">:</span> colors<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                border<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>borderWidth<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px solid</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token punctuation\">{</span>labels <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"legend-label\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>labels<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I’m just using some classic JSX to iterate over my chart’s labels and create a <code class=\"language-text\">&lt;li&gt;</code> for each label with a color block and its corresponding text. I’m also giving each item an interactive click handler. So far so good!</p>\n<p>The tricky part for me was the next step. Chart.js doesn’t automatically render this legend for you — you need to call <code class=\"language-text\">generateLegend()</code> on your chart instance in order for the legend to actually render in the DOM. So I needed to access the chart’s DOM node in order to call <code class=\"language-text\">generateLegend()</code>. My immediate thought (and probably yours too) was, “This sounds like a great use case for React’s <strong>useRef</strong> hook!”, and I was right, sort of.</p>\n<p>Unfortunately, I found that the chart legend still wasn’t rendering 100% of the time. Eventually I realized that I had created a race condition where if the chart’s DOM node didn’t exist yet, the legend wouldn’t render. “Fine,” I thought, “I’ll just use React’s <strong>useEffect hook</strong>, use the chart’s ref as a dependency, and update the legend whenever the ref changes.” But I was foiled again. I soon found out that you can’t use a ref as a dependency for <strong>useEffect</strong>. Here’s an explanation of why not to use a ref as a dependency in a useEffect call, from the <a href=\"https://reactjs.org/docs/hooks-faq.html#how-can-i-measure-a-dom-node\">React docs</a>: “…an object ref doesn’t notify us about changes to the current ref value.” So it follows that <strong>useEffect</strong> will never get called if we never get notified about changes to the ref value.</p>\n<p>Instead, React recommends that you use a different hook — <strong>useCallback</strong> — to notify us whenever the ref changes. Now we can call <code class=\"language-text\">generateLegend()</code> inside of this callback. Then, instead of giving your chart instance’s 'ref' attribute a standard ref object created from <strong>useRef</strong>, we give it that callback we just defined. When the DOM node changes, it will call <strong>useCallback</strong>, our legend will be generated, and all will be well! Here’s what it looks like, and note that I’m using the <strong>useState</strong> hook as well in order to store state for the DOM node and our legend:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>legend<span class=\"token punctuation\">,</span> setLegend<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>ref<span class=\"token punctuation\">,</span> setRef<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> onRefChange <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ref value changed to node</span>\n  <span class=\"token function\">setRef</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// e.g. change ref state to trigger re-render</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setLegend</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>chartInstance<span class=\"token punctuation\">.</span><span class=\"token function\">generateLegend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And here is what rendering the <code class=\"language-text\">Doughnut</code> component inside a parent component will now look like, using that callback for its 'ref' attribute:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Parent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// ...your parent component's contents</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Doughnut date<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>chart<span class=\"token punctuation\">}</span> options<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>options<span class=\"token punctuation\">}</span> ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>onRefChange<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One last thing: I wanted my legend to be interactive, similar to Chart.js’s default legend. As I mentioned above, I passed a click handler to each <code class=\"language-text\">&lt;li&gt;</code> in my legend callback. The default Chart.js legend responds to clicks by crossing out the legend item and removing it from the chart, creating an interactive chart where the user can choose which data is being visualized. To replicate this behavior, I wrote the following click handler:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleLegendClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> datasetIndex<span class=\"token punctuation\">,</span> chartInstance</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> e <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span>\n  chartInstance<span class=\"token punctuation\">.</span><span class=\"token function\">getDatasetMeta</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>datasetIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>hidden <span class=\"token operator\">=</span>\n    chartInstance<span class=\"token punctuation\">.</span><span class=\"token function\">getDatasetMeta</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>datasetIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>hidden <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  e<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">toggle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"crossed-line\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  chartInstance<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I simply access the relevant index in the chart instance’s data and toggle it’s ‘hidden’ attribute and then toggle the element’s class name (I use CSS to cross out elements in the “crossed-line” class). Easy as pie (or…doughnuts, in this case? Sorry, I couldn’t help it). Here’s what it looks like!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8f61329b2bcd4d1807101e037502955a/8c557/doughnut_normal_view.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQoz1VSSWsUQRSen+Uv8KAIguDBg150onFDEQQhJmguGhRFLy54EuJJRIh4kJxixCzDmExPppfpySyx0+N0dXVVddvdtTzp6pmR1KHqUe9bXr1XlcFgYFq2Zdvdbk9ICeVSSumYUmpalu04GGN9PcnLIqowxlAYRlHEGBNc7Lb7nZqRx3EJ4pxjjAkhWZYqAEZ836jR38NSv1IcGie5eN5cOfb02ccT152L9/DAKxGlEwAE7mpQu9ZYqO4cnz1YXSucAUCoosKv3d1TP159328ip9c6f9d88FJLypLPyAj9vB1ayyREncdvG2dvJpQWZKkEAGwbn1bWFkTOAcB58q5ZnVOltZYmfyy8cQt5LQDw17eM01fDTk+XrdPM37HmL9gv3vc/f2ucnHFff9CNkWXNf5M42JwLG48OttfNS/PG5fu54BWY9I8DtJe/7J27Y5y5YS+9SVkM0/7qPTo0R8ai8fDKXnUROe74zcw7xG1XaI2EUBYgMZ0JQJokXv1XFEVKqTTLGBrlWV4qFuS+57bcOiUxz7IxQ8rpTPMsjYbtiFCEgkwDlBz/goLs+sP6fo8RwoXQDZL/fY8uBTo70f0HcrEdYM6+eRgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"doughnut normal view\"\n        title=\"doughnut normal view\"\n        src=\"/static/8f61329b2bcd4d1807101e037502955a/8c557/doughnut_normal_view.png\"\n        srcset=\"/static/8f61329b2bcd4d1807101e037502955a/0b533/doughnut_normal_view.png 500w,\n/static/8f61329b2bcd4d1807101e037502955a/8c557/doughnut_normal_view.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>And with some items crossed out:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/01f0b6af009a0a95f235049cf2adfe7d/8c557/doughnut_items_crossed_out.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVQoz22Sz2vUQBTH8/949k+wqFcp6E1c7cGDhRZPFS8VVsSDilgKRUsPrgcPooKoIFqtbdlS66Z13WyymXTTza/NxKbd7CYz855MdhtK6WMOw3zf53358kZp6rppEmLtMs7xqAAAETnnpkmMVstx3eLx+EXxgyCkNKQUQdg+tW0jG/RyFQCARhGlNI5jREwHg+5fnZI2FwJzXJFd+ZjnnzfPzFReV273tu7QoDW0KHxiv9uYKq+PXd04X2o9WWJCSFjk2nbHPHv/6YN3q86eFv+e3d8qZ0yMeCEbmuX5+viku/6r/eaTeu7a3odvQ1g2vSUbpeqCHwWIaBnLta+Tg2Q/Z6Xa56wxcdd4vIiIGeLO9RnyaBEKZ9Ujl9bmXuo/SdiZ2nw1vfICMpYnAuTSWrv3rH55ulurOx+X1bGS/f7LKLMsARXtx5W1+fHVuZvVpXrYLtKOMne8P7dm1Qs31IsTzYcLGcsknIQRNayUMwSw/wXbPomT3sgzL2qY1PWYEP1eEu5okWExMVqqQv1dq1E9TNJh+BObBMTAqDlt4jjeQXxQqMMGRffc700t9P2k3xcIDLg4Ik+UJDiXp/gkacYOkxSO2Z6GIcApI/8DWWxUsTGGaW4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"doughnut with items crossed out\"\n        title=\"doughnut with items crossed out\"\n        src=\"/static/01f0b6af009a0a95f235049cf2adfe7d/8c557/doughnut_items_crossed_out.png\"\n        srcset=\"/static/01f0b6af009a0a95f235049cf2adfe7d/0b533/doughnut_items_crossed_out.png 500w,\n/static/01f0b6af009a0a95f235049cf2adfe7d/8c557/doughnut_items_crossed_out.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>I hope you enjoyed learning about custom legends in Chart.js! If you want to check out the repo for the project in which I implemented these charts, it’s available <a href=\"https://github.com/hankthemason/finances-tracker\">here</a>.</p>"}},"pageContext":{}},"staticQueryHashes":[]}