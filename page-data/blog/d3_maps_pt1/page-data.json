{
    "componentChunkName": "component---src-templates-post-template-js",
    "path": "/blog/d3_maps_pt1",
    "result": {"data":{"markdownRemark":{"frontmatter":{"date":"2021-06-24","title":"Build a map of NYPD precincts with React & D3, Part 1","path":"/blog/d3_maps_pt1"},"html":"<p>We are going to use React and D3 to build a map of police precincts in NYC. Then we’ll use publicly available records on NYPD misconduct to turn it into a colorized heat map. Let’s get started!</p>\n<p><strong>Step 1: Create a new react app and install D3</strong></p>\n<p>Open a new terminal and navigate to where you want to keep your project. Type the following commands into your terminal:</p>\n<div class=\"console\">\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ create-react-app nypd-precinct-map\n$ cd nypd-precinct-map\n$ yarn add d3</code></pre></div>\n</div>\n<p><strong>Step 2: Understanding maps in D3</strong></p>\n<p>In order to render a map in D3, we are going to need 3 things:</p>\n<p>-The geographic information used to render the lines of our map, typically in <strong>GeoJSON</strong> or <strong>TopoJSON</strong> format. We will be using a GeoJSON file for this project.</p>\n<p>-A projection function which will translate points with latitude/longitude coordinates on a 3-dimensional sphere to points with x/y coordinates on a 2-dimensional plane. D3 provides a handful of projections; we will be using the <strong>geoAlbers</strong> projection.</p>\n<p>-A geographic path generator that will transform our GeoJSON file into an SVG path data string. D3 provides us with a <code class=\"language-text\">geoPath()</code> function to do this. We can give it the projection we just made as a first argument.</p>\n<p><strong>Step 3: Make the Map component</strong></p>\n<p>Now we can start building the map! Create a new file, <strong>Map.jsx</strong> in your <strong>/src</strong> directory. We want to import D3 and import React’s <strong>useRef</strong> hook. Then we’ll create and export a functional component called <code class=\"language-text\">Map</code>, which as of now takes in a prop called <strong>geoJSON</strong>, and returns an <code class=\"language-text\">&lt;svg></code> element wrapped in a <code class=\"language-text\">&lt;div></code>. We also need to create a variable called <code class=\"language-text\">svgRef</code> using the <strong>useRef</strong> hook. This will store a reference to the <code class=\"language-text\">&lt;svg></code> element that contains our map, and it will allow us to call D3 methods on it. The component will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRef <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> d3 <span class=\"token keyword\">from</span> <span class=\"token string\">'d3'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Map</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> geoJson <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props\n\n  <span class=\"token keyword\">const</span> svgRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">'wrapper'</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>svg className<span class=\"token operator\">=</span><span class=\"token string\">'precincts-map'</span> ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>svgRef<span class=\"token punctuation\">}</span> height<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">500</span><span class=\"token punctuation\">}</span> width<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">500</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we are ready to start using D3! First, we need to import another hook from React: <strong>useEffect</strong>. <strong>useEffect</strong> is used for executing side effects inside a functional component. Manipulating the DOM, which we will be doing with D3, is one such example of a side effect. Inside the <strong>useEffect hook</strong>, we’ll run the afore-mentioned projection and path generator functions. Then we’ll call a helper function called <code class=\"language-text\">renderMap()</code> to work D3’s magic and build our map!</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRef<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> d3 <span class=\"token keyword\">from</span> <span class=\"token string\">'d3'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Map</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> geoJson <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props\n\n  <span class=\"token keyword\">const</span> svgRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">renderMap</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">mapData<span class=\"token punctuation\">,</span> path</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>svgRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>mapData<span class=\"token punctuation\">.</span>features<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">precinct-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">[</span><span class=\"token string\">'Precinct'</span><span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stroke'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'#000000'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stroke-width'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.2'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fill'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'transparent'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> height <span class=\"token operator\">=</span> svgRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>clientHeight\n    <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> svgRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>clientWidth\n\n    <span class=\"token keyword\">const</span> projection <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">geoAlbers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fitSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>height<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> geoJson<span class=\"token punctuation\">)</span>\n\n\t  <span class=\"token keyword\">const</span> pathGenerator <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">geoPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">projection</span><span class=\"token punctuation\">(</span>projection<span class=\"token punctuation\">)</span> \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>geoJson<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">renderMap</span><span class=\"token punctuation\">(</span>geoJson<span class=\"token punctuation\">,</span> pathGenerator<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>geoJson<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">'wrapper'</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>svg \n        className<span class=\"token operator\">=</span><span class=\"token string\">'precincts-map'</span> \n        ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>svgRef<span class=\"token punctuation\">}</span> \n        height<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">500</span><span class=\"token punctuation\">}</span> \n        width<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">500</span><span class=\"token punctuation\">}</span>\n        style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">marginTop</span><span class=\"token operator\">:</span> <span class=\"token string\">'2em'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It might look like a lot is going on here, but don’t panic! First look at the <strong>useEffect</strong> hook. We get the height and width of the bounding SVG element, and use those values to scale our projection correctly with D3’s <code class=\"language-text\">fitSize()</code> function. Then we call D3’s <code class=\"language-text\">geoPath()</code> function to generate our path. If our GeoJSON data is present, we can go ahead and render the map. Our <code class=\"language-text\">renderMap()</code> function is classic D3 and might appear odd, but it is actually simple when you break it down.</p>\n<p>First we call <code class=\"language-text\">.select()</code> to select our <code class=\"language-text\">svgRef</code>, and then we call <code class=\"language-text\">selectAll()</code> to select the path elements we are going to be rendering (technically, we haven’t rendered these elements yet, which might seem confusing, but this is part of D3’s magic). Each of these elements will correspond with a precinct, which are defined in our GeoJSON object as ‘features.’ Next comes D3’s signature data join, in which we specify the data we will be joining to the path elements. This is how we bind each path element to a precinct (or feature). After that, we use D3’s <code class=\"language-text\">.attr()</code> method to give each <code class=\"language-text\">&lt;path></code> element a <strong>'d'</strong> attribute that corresponds to the <strong>path</strong> string we generated previously with the <code class=\"language-text\">geoPath()</code> function. This is how we define each precinct’s shape. After that, we give the <code class=\"language-text\">&lt;path></code> elements some more (optional) attributes that define their fill and stroke color. And now the Map component is complete! We are one step away from rendering our map.</p>\n<p><strong>Step 4: Update the App.js component</strong></p>\n<p>The only thing we have left to do is to update the App.js file to import the <code class=\"language-text\">Map</code> component, fetch the GeoJSON data, and then render the <code class=\"language-text\">Map</code> component with the GeoJSON data as a prop. This is what it will look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'./App.css'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Map <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./Map'</span>\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token string\">'https://opendata.arcgis.com/datasets/c35786feb0ac4d1b964f41f874f151c1_0.geojson'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"App\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Map geoJson<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>First, we need to import React’s <strong>useState</strong> and <strong>useEffect</strong> hooks. Then we’ll import our <code class=\"language-text\">Map</code> component. Then we create a variable <code class=\"language-text\">url</code> to store the address we’ll be fetching the GeoJSON data from. We are getting our data from <strong>ArcGIS</strong>, a platform for open data sharing, but you can find GeoJSON data in plenty of other places. We’ll store our data using React’s <strong>useState</strong> hook. If you’re not familiar with <a href=\"https://reactjs.org/docs/hooks-state.html\">React hooks</a>, don’t worry, just know that <strong>useState</strong> allows us to set and update state in a functional component (such as this one). Next we use another hook, useEffect, to fetch the data, convert it to a JSON object, and set it to our instance of state (using the setData function that useState returned when we initially invoked it). Remember, useEffect is used for executing side effects in a functional component, and fetching data is another instance of a side effect. Lastly, we add the Map component into our return statement, passing it the data variable as its geoJson prop. Now our map should be working! In your terminal, type: <code class=\"language-text\">$ yarn start</code> to run the React app, and then navigate to <a href=\"http://localhost:3000\">http://localhost:3000</a> in your browser to see it in action. It should look like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2c8cd837f79e1108a4201c722bcd5db5/8c557/bw_map.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.199999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQoz6WRDQuCMBCG/f//pTKnRuV39IMcO9xtd1ekCJYZhg8Pg2O8vGMXKJXGcRolp6NK92HUq0aj3WE6qlAlkUou5+yaF3lWBI8NBLQAMxtj2rYFAO/9/JqIfjUbYwAAEZ1zIvKleSnJzFrrruustYj4X1hEtNYwwsxrw0TkvbfWAsDw+LXNIjKEiQgRiWjxt3nGkHHOMbP08ALb9ny/VXVdNi+Luso/LSfnu01dPgFBlm066L5boQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"basic map rendering\"\n        title=\"basic map rendering\"\n        src=\"/static/2c8cd837f79e1108a4201c722bcd5db5/8c557/bw_map.png\"\n        srcset=\"/static/2c8cd837f79e1108a4201c722bcd5db5/0b533/bw_map.png 500w,\n/static/2c8cd837f79e1108a4201c722bcd5db5/8c557/bw_map.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Congratulations! You’ve successfully rendered a map of NYC’s police precincts! Next we are going to use public records to turn our map into a heat map showing how many allegations of misconduct are connected to each precinct.</p>\n<p>Here is Part 2 of this tutorial: <a href=\"https://hankthemason.github.io/d3_maps_pt1\">https://hankthemason.github.io/d3_maps_pt1</a></p>\n<p>Here is the GitHub repo for this project: <a href=\"https://github.com/hankthemason/nyc-precinct-map-tutorial-pt1\">https://github.com/hankthemason/nyc-precinct-map-tutorial-pt1</a></p>"}},"pageContext":{}},
    "staticQueryHashes": []}